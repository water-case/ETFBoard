package com.myboard.etfboard.etfkorea.controller;

import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.servlet.ModelAndView;

import com.myboard.etfboard.etfkorea.vo.EtfVO;

@Controller("etfkoreaController")
public class EtfkoreaControllerImpl implements EtfkoreaController{

	// etf 조회
	@Override
	@RequestMapping(value="/etfkorea", method=RequestMethod.GET)
	public ModelAndView viewETFKOREA(HttpServletRequest request, HttpServletResponse response) throws Exception {
		// 크롤링
		String address = "https://finance.naver.com/api/sise/etfItemList.nhn?etfType=0&targetColumn=market_sum&sortOrder=desc&_callback=window.__jindo2_callback._4777";
		Document doc = Jsoup.connect(address).get();
		// json 데이터로 파싱
		String str = doc.text();
		String cut = str.substring(0, str.length()-2).substring(64);
		
		// json 데이터를 분해하기
		JSONParser jsonParse = new JSONParser();
		JSONObject jsonObj = (JSONObject) jsonParse.parse(cut);
		JSONArray etfArray = (JSONArray) jsonObj.get("etfItemList");
		
		List<EtfVO> etfList = new ArrayList<EtfVO>();
		for(int i=0; i<etfArray.size(); i++) {
			JSONObject etfObject = (JSONObject) etfArray.get(i);
			
			String tapCode = (String) etfObject.get("etfTabCode");
			if(tapCode != "3" && tapCode != "7") {
				String itemcode = (String) etfObject.get("itemcode");	// 종목코드
				String itemname = (String) etfObject.get("itemname");	// 종목이름
				String nowVal = (String) etfObject.get("nowVal");	// 현재가
				String changeVal = (String) etfObject.get("changeVal");	// 전일비
				String changeRate = (String) etfObject.get("changeRate");// 등락률
				String nav = (String) etfObject.get("nav");		// nav
				String guant = (String) etfObject.get("guant");		// 거래량
				String marketSum = (String) etfObject.get("marketSum");	// 시가총액
				
				EtfVO etfVO = new EtfVO(itemcode, itemname, nowVal, changeVal, changeRate, nav, guant, marketSum);
				etfList.add(etfVO);
			}
		}
		
		ModelAndView mav = new ModelAndView();
		mav.setViewName("/etfkorea");
		mav.addObject("etfList", etfList);
		
		return mav;
	}
	
}
